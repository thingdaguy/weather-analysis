<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Map + Weather (Open-Meteo)</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Qt WebChannel (optional) -->
    <script src="qrc:///qtwebchannel/qwebchannel.js" defer></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .map-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            z-index: 500;
            font-family: sans-serif;
            border-left: 4px solid #e74c3c;
        }

        /* Text label for islands */
        .text-label {
            font-size: 14px;
            font-weight: bold;
            color: #c0392b;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="map-info" id="coords">ğŸ“Œ Click vÃ o báº£n Ä‘á»“ Ä‘á»ƒ xem thá»i tiáº¿t</div>

<script>
/* =========================
   FETCH WEATHER â€“ OPEN METEO
========================= */
async function fetchWeather(lat, lng) {
    const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${lat}&longitude=${lng}` +
        `&current_weather=true` +
        `&hourly=precipitation` +
        `&daily=temperature_2m_max,temperature_2m_min` +
        `&timezone=auto`;

    try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.current_weather || !data.daily) return null;

        return {
            temp: data.current_weather.temperature,
            wind: data.current_weather.windspeed,
            precipitation: data.hourly.precipitation[0],
            temp_max: data.daily.temperature_2m_max[0],
            temp_min: data.daily.temperature_2m_min[0]
        };
    } catch {
        return null;
    }
}

/* =========================
   INIT MAP
========================= */
document.addEventListener("DOMContentLoaded", () => {

    const map = L.map("map", {
        // Shift Vietnam slightly LEFT to reserve right-side panel space
        center: [16.0, 110.5],
        zoom: 6,
        minZoom: 3,
        maxZoom: 18,
        preferCanvas: true
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
        maxZoom: 19
    }).addTo(map);

    /* =========================
       ISLAND LABELS
    ========================= */
    const hoangSaLabel = L.divIcon({
        className: "text-label",
        html: "HoÃ ng Sa",
        iconSize: [100, 20],
        iconAnchor: [50, 10]
    });
    L.marker([16.5, 112.3], { icon: hoangSaLabel, interactive: false }).addTo(map);

    const truongSaLabel = L.divIcon({
        className: "text-label",
        html: "TrÆ°á»ng Sa",
        iconSize: [100, 20],
        iconAnchor: [50, 10]
    });
    L.marker([10.0, 114.0], { icon: truongSaLabel, interactive: false }).addTo(map);

    /* =========================
       MARKER STYLE
    ========================= */
    const redIcon = L.icon({
        iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
        shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41]
    });

    let marker = null;

    /* =========================
       QT BRIDGE
    ========================= */
    if (window.qt) {
        new QWebChannel(qt.webChannelTransport, channel => {
            window.mapBridge = channel.objects.pywebview;
        });
    }

    /* =========================
       MAP CLICK
    ========================= */
    map.on("click", async (e) => {
        const lat = +e.latlng.lat.toFixed(4);
        const lng = +e.latlng.lng.toFixed(4);

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng], { icon: redIcon }).addTo(map);

        document.getElementById("coords").innerHTML =
            `ğŸ“ ${lat}, ${lng} | Äang láº¥y dá»¯ liá»‡u...`;

        const w = await fetchWeather(lat, lng);

        let html = `<b>ğŸ“ ${lat}, ${lng}</b><hr>`;

        if (w) {
            html += `
                ğŸŒ¡ï¸ ${w.temp} Â°C<br>
                ğŸ”º Max: ${w.temp_max} Â°C<br>
                ğŸ”» Min: ${w.temp_min} Â°C<br>
                ğŸŒ§ï¸ ${w.precipitation} mm<br>
                ğŸŒ¬ï¸ ${w.wind} km/h
            `;
            document.getElementById("coords").innerHTML =
                `ğŸŒ¡ï¸ ${w.temp}Â°C | ğŸŒ¬ï¸ ${w.wind} km/h`;
        } else {
            html += "âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u thá»i tiáº¿t";
        }

        marker.bindPopup(html).openPopup();

        if (window.mapBridge) {
            window.mapBridge.on_map_click(lat, lng, JSON.stringify(w));
        }
    });
});
</script>

</body>
</html>
