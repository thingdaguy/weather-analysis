<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vietnam Map + Weather (Open-Meteo)</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="qrc:///qtwebchannel/qwebchannel.js" defer></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      #map {
        width: 100vw;
        height: 100vh;
      }

      .map-info {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        z-index: 500;
        font-family: sans-serif;
        border-left: 4px solid #e74c3c;
      }

      /* Text label for islands */
      .text-label {
        font-size: 14px;
        font-weight: bold;
        color: #c0392b;
        white-space: nowrap;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="map-info" id="coords">ğŸ“Œ Click vÃ o báº£n Ä‘á»“ Ä‘á»ƒ xem thá»i tiáº¿t</div>

    <script type="module">
      import { getLocationWeather } from "./fetchApi/fetchAddressWeather.js";
      document.addEventListener("DOMContentLoaded", () => {
        const bounds = L.latLngBounds([8.1, 101.5], [23.5, 111.0]);

        const map = L.map("map", {
          center: [20, 0], // nhÃ¬n toÃ n cáº§u
          zoom: 4, // zoom tháº¥p Ä‘á»ƒ tháº¥y TrÃ¡i Äáº¥t
          minZoom: 4,
          maxZoom: 18,
          worldCopyJump: true, // kÃ©o vÃ´ háº¡n trÃ¡i/pháº£i
          preferCanvas: true,
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
          maxZoom: 19,
        }).addTo(map);

        /* =========================
       ISLAND LABELS
    ========================= */
        const hoangSaLabel = L.divIcon({
          className: "text-label",
          html: "HoÃ ng Sa",
          iconSize: [100, 20],
          iconAnchor: [50, 10],
        });
        L.marker([16.5, 112.3], {
          icon: hoangSaLabel,
          interactive: false,
        }).addTo(map);

        const truongSaLabel = L.divIcon({
          className: "text-label",
          html: "TrÆ°á»ng Sa",
          iconSize: [100, 20],
          iconAnchor: [50, 10],
        });
        L.marker([10.0, 114.0], {
          icon: truongSaLabel,
          interactive: false,
        }).addTo(map);

        const redIcon = L.icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
          shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
        });

        let marker = null;

        if (window.qt) {
          new QWebChannel(qt.webChannelTransport, (channel) => {
            window.mapBridge = channel.objects.pywebview;
          });
        }

        map.on("click", async (e) => {
          const lat = +e.latlng.lat.toFixed(4);
          const lng = +e.latlng.lng.toFixed(4);

          if (marker) map.removeLayer(marker);
          marker = L.marker([lat, lng], { icon: redIcon }).addTo(map);

          const coordsEl = document.getElementById("coords");

          // 1ï¸âƒ£ LOADING
          coordsEl.innerHTML = `ğŸ“ ${lat}, ${lng}<br>â³ Äang láº¥y dá»¯ liá»‡u...`;

          const result = await getLocationWeather(lat, lng);

          let html = `<b>ğŸ“ ${lat}, ${lng}</b><hr>`;

          // 2ï¸âƒ£ FAIL
          if (!result || !result.weather) {
            coordsEl.innerHTML = `âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u`;
            marker.bindPopup(html + "âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u").openPopup();
            return;
          }

          const { address, weather } = result;

          // 3ï¸âƒ£ RESET coords (â— QUAN TRá»ŒNG)
          coordsEl.innerHTML = "";

          // ğŸ“ Äá»ŠA CHá»ˆ
          if (address?.full) {
            html += `
                ğŸ  <b>Äá»‹a chá»‰</b><br>
                ${address.full}<hr>
                `;
          }

          const locationText =
            address?.city || address?.province || `${lat}, ${lng}`;

          coordsEl.innerHTML = `ğŸ“ ${locationText}`;

          // ğŸŒ¤ï¸ THá»œI TIáº¾T
          html += `
                ğŸŒ¡ï¸ ${weather.temp} Â°C<br>
                ğŸ”º Max: ${weather.temp_max} Â°C<br>
                ğŸ”» Min: ${weather.temp_min} Â°C<br>
                ğŸŒ§ï¸ ${weather.precipitation} mm<br>
                ğŸŒ¬ï¸ ${weather.wind} km/h
            `;

          coordsEl.innerHTML += ` | ğŸŒ¡ï¸ ${weather.temp}Â°C | ğŸŒ¬ï¸ ${weather.wind} km/h`;

          marker.bindPopup(html).openPopup();

          // ğŸš€ PYQT
          if (window.mapBridge) {
            window.mapBridge.on_map_click(lat, lng, JSON.stringify(result));
          }
        });
      });
    </script>
  </body>
</html>
